---
title: "final project"
author: "Jason Tan"
date: "11/2/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
```

Setting all paths to read data

```{r}
HOME <- "~/Desktop/STAT425/project/predictingcovid"
setwd(HOME)
COVARDATDIR <- paste(HOME, 'covardat', sep='/')
JHUDATDIR <- paste(HOME, 'jhudat', sep='/')

MASK_USE_PATH <- paste(COVARDATDIR, "mask-use-by-county.csv", sep='/')
MOBILITY_PATH <- paste(COVARDATDIR, "2020_US_Region_Mobility_Report.csv", sep='/')
SOCIECOWEATHER_PATH <- paste(COVARDATDIR, "US_counties_COVID19_health_weather_data_julyonly.csv", sep='/') # already filtered for july 15-26
JHU_PATH <- paste(JHUDATDIR, sep='/')
```

Dealing with all covariates

```{r}
# all county fips code columns are named, "countyfips"

mask_use <- read_csv(MASK_USE_PATH) %>% 
    mutate(never_rarely_mask = NEVER + RARELY, countyfips = COUNTYFP) %>%  # also converted name of fips code column for join
    select(countyfips, never_rarely_mask)
mobility <- read_csv(MOBILITY_PATH) %>% 
    filter(!is.na(census_fips_code) & (date > dmy("06-07-2020")) & (date < dmy("20-07-2020"))) %>% 
    select(-c(
        country_region_code,
        country_region,
        sub_region_1,
        sub_region_2,
        metro_area,
        iso_3166_2_code,
        date
    )) %>% 
    # only keep informative data
    select(c(
        census_fips_code,
        retail_and_recreation_percent_change_from_baseline,
        workplaces_percent_change_from_baseline
    )) %>% 
    filter(!is.na(retail_and_recreation_percent_change_from_baseline) & !is.na(workplaces_percent_change_from_baseline)) %>%  # can modify which mobility indicators to use later
    group_by(census_fips_code) %>% 
    summarise_if(is.numeric, mean, na.rm=T) %>% 
    # convert name of fips code column for join
    mutate(countyfips = census_fips_code) %>% 
    select(-census_fips_code) %>% 
    select(countyfips, everything())

sew <- read_csv(SOCIECOWEATHER_PATH) %>% 
    select(fips, 
           stay_at_home_effective,
           population_density_per_sqmi,
           percent_uninsured,
           percent_non_hispanic_white,
           per_capita_income,
           percent_65_and_over,
           ELEV_M,
           mean_temp_15d_avg) %>% 
    mutate(stay_at_home = ifelse(stay_at_home_effective == 'yes', 1, 0)) %>% 
    select(fips, stay_at_home, everything()) %>% 
    group_by(fips) %>% 
    summarise_if(is.numeric, mean, na.rm = T) %>% 
    # convert name of fips code column for join
    mutate(countyfips = fips) %>% 
    select(-fips) %>% 
    select(countyfips, everything())

allcovars <- mask_use %>% 
    inner_join(mobility, by=c("countyfips")) %>% 
    inner_join(sew, by=c("countyfips")) %>% 
    drop_na()
# write_csv(allcovars, paste(OVARDATDIR, 'allcovars.csv', sep='/'))
    
```

Dealing with case JHU data

```{r}
## JHU dat with only 7 days, even though directory has 8 days (used for computing differences)
jhutotal <- lapply(list.files(JHU_PATH)[1:length(list.files(JHU_PATH)) - 1], 
                 function(x) 
                     read_csv(paste(JHU_PATH, x, sep='/')) %>% 
                     mutate(FIPS = as.factor(FIPS)) %>% 
                     select(FIPS, Confirmed, Deaths) %>% 
                     drop_na()
                 ) %>% 
    reduce(inner_join, by='FIPS') %>% 
    mutate(
        countyfips = FIPS,
        mean_confirmed_7d_total = rowSums(select(., contains("Confirmed."))) / 7, 
        mean_deaths_7d_total = rowSums(select(., contains("Deaths."))) / 7
        ) %>% 
    select(countyfips, mean_confirmed_7d_total, mean_deaths_7d_total)
write_csv(jhutotal, paste(HOME, 'all_jhu_total.csv', sep='/'))
```

```{r}
jhudiff <- lapply(list.files(JHU_PATH), 
                 function(x) 
                     read_csv(paste(JHU_PATH, x, sep='/')) %>% 
                     mutate(FIPS = as.factor(FIPS)) %>% 
                     select(FIPS, Confirmed, Deaths) %>% 
                     drop_na()
                 ) %>% 
    reduce(inner_join, by='FIPS') %>% 
    mutate(
        countyfips = FIPS,
        # diffs
        mean_confirmed_7d_diff = (Confirmed.y.y.y.y - Confirmed.x) / 7,
        mean_deaths_7d_diff = (Deaths.y.y.y.y - Deaths.x) / 7,
        ) %>%
    select(countyfips, mean_confirmed_7d_diff, mean_deaths_7d_diff)
write_csv(jhudiff, paste(HOME, 'all_jhu_diff.csv', sep='/'))
```

```{r}
all_jhu_combined <- inner_join(jhutotal, jhudiff, by='countyfips')
write_csv(all_jhu_combined, paste(HOME, 'all_jhu_combined.csv', sep='/'))
```


Combining JHU with covariates

```{r}
comb <- inner_join(jhu, allcovars, by='countyfips')
# write_csv(comb, paste(HOME, 'combined.csv', sep='/'))


# weird number of increases

```


